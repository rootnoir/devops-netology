# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя
  
  - Определить текущий идентификатор операции: db.currentOp()
  - Завершить операцию: db.killOp()
  
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB
  
  - Во-первых, установить ограничение времени выполнения операции, используя метод maxTimeMS().
  - Во-вторых, исходя из конкретного вида (CRUD) операции, определить, что является причиной длительного выполнения. После чего, устранить эту причину. Возможными направлениями могут быть: 
    - при медленной записи, проверить какой режим гарантии durability использует операция;
    - при медленном чтении, рассмотреть возможность чтения с реплик;
    - при медленном удалении, рассмотреть удаление не отдельных документов, а коллекций, либо подготовку документов для удаления в отдельную коллекцию, которая затем будет удалена.

## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?

  - Предположительно, используется активный метод удаления истекших ключей. Он запускается каждые 100 миллисекунд и удаляет не более 200 ключей в секунду. Но если общее количество истекших ключей за одну секунду превышает 25% от всех ключей у которых установлен срок действия, то Redis будет заблокирован, пока количество истекших ключей не станет меньше 25%.

## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?
- наиболее вероятная причина:
```
Sometimes the “during query” form happens when millions of rows are being sent as part of one or more queries. 
If you know that this is happening, you should try increasing net_read_timeout from its default of 30 seconds to 60 seconds or longer, 
sufficient for the data transfer to complete.
```
- в этом случае поможет увеличение значения `net_read_timeout`

Какие пути решения данной проблемы вы можете предложить?
 - Собственно, пути решения отлично расписаны в https://dev.mysql.com/doc/refman/8.0/en/error-lost-connection.html
   - убедиться в отсутствии "железных" и "сетевых" проблем.
   - посмотреть на логи сервиса для корректного определения типа проблемы.
   - определить тип проблемы и применить подходящее решение из https://dev.mysql.com/doc/refman/8.0/en/error-lost-connection.html

## Задача 4


Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?
- Это происходит из-за нехватки виртуальной памяти.

Как бы вы решили данную проблему?
- Для решения проблемы необходимо: 
  - убедиться в правильности настроек операционной системы для PostgreSQL согласно документации https://www.postgresql.org/docs/14/kernel-resources.html.
  - проверить и настроить swap.
  - выполнить настройку ядра отключив перераспределение памяти vm.overcommit_memory=2.

---
